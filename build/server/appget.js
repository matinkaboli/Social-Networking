const moment=require("moment"),svgCaptcha=require("svg-captcha"),showData=require("./showdata"),gen=require("./gen"),gets=(e,s)=>{const n=(e,s,n)=>{if(e.session&&e.session.user)return n();e.flash("status","status0"),s.redirect("/")};e.get("/",(e,s)=>{if(e.session&&e.session.user)s.redirect("/you");else{const n=svgCaptcha.create({size:6,noise:2});e.session.captcha=n.text,s.render("index.njk",{captcha:n.data,flash:e.flash("status")})}}),e.get("/setting",n,(e,n)=>{s.checkUsername(e.session.user.toLowerCase()).then(e=>{n.render("setting.njk",{data:e[0]})}).catch(e=>{console.error(e),n.send("Error...")})}),e.get("/you",n,(e,n)=>{const t={username:e.session.user};s.User.find(t,(s,t)=>{n.render("admin.njk",{data:t[0],flash:e.flash("status")})})}),e.get("/q",(e,n)=>{const t=e.query.q,r=parseInt(e.query.tab);s.Post.find({title:{$regex:`.*${t}.*`,$options:"i"}}).skip(r).limit(20).sort({time:1}).then(e=>{const r=[],o=gen.getInfoSearch(e,s,r);!function e(){const s=o.next();s.done?n.render("searchall.njk",{list:r,q:t}):s.value.then(e)}()})}),e.get("/u/:username",(e,n)=>{if(e.query.tab){const t=e.params.username.toLowerCase();s.User.find({username:t},(s,r)=>{if("[]"!=JSON.stringify(r)){if("following"==e.query.tab){const s=parseInt(e.query.page);let o=10*s-10,a=10*s;const i=[];for(;o<a;o++)i.push(r[0].following[o]);const u=e=>void 0===e;let d=i.some(u);i.every(u)?n.render("listuser.njk",{status:1,done:!0,list:i,username:t,numPage:s}):n.render("listuser.njk",{status:1,done:!1,list:i,username:t,numPage:s,some:d})}else if("follower"==e.query.tab){const s=parseInt(e.query.page);let o=10*s-10,a=10*s;const i=[];for(;o<a;o++)i.push(r[0].follower[o]);const u=e=>void 0===e;let d=i.some(u);i.every(u)?n.render("listuser.njk",{status:2,done:!0,list:i,username:t,numPage:s}):n.render("listuser.njk",{status:2,done:!1,list:i,username:t,numPage:s,some:d})}}else n.render("usernotfound.njk",{url:t})})}else{const t=e.params.username.toLowerCase();s.User.find({username:t},(r,o)=>{if(r)throw r;if("[]"==JSON.stringify(o))n.render("usernotfound.njk",{url:t});else if(e.session&&e.session.user){const r=e.session.user.toLowerCase();let a,i,u=o[0].follower;s.checkUsername(r).then(e=>{a=e[0]._id}).then(()=>{i=u.some(e=>e===a);const r=[];s.Post.find({user:o[0]._id}).limit(10).sort({time:1}).exec().then(u=>{const d=gen.getInfo(u,a,r);!function a(){const u=d.next();u.done?s.Post.find({user:o[0]._id},(s,a)=>{i?n.render("userin.njk",{data:o[0],created:moment(o[0].created).fromNow(),self:e.session.user,isFollowed:!0,list:r,url:t,lenPost:a.length}):n.render("userin.njk",{data:o[0],created:moment(o[0].created).fromNow(),self:e.session.user,isFollowed:!1,list:r,url:t,lenPost:a.length})}):u.value.then(a)}()})}).catch(e=>{console.error(e)})}else n.render("userout.njk",{created:moment(o[0].created).fromNow(),data:o[0]})})}}),e.get("/contact",(e,s)=>{s.render("contact.njk")}),e.get("/u/:username/s/:address",(e,n)=>{const t=e.params.username.toLowerCase(),r=e.params.address;s.User.find({username:t},(e,o)=>{"[]"==JSON.stringify(o)?n.send("Username Does not exist."):s.Post.find({_id:r},(e,s)=>{if("[]"===JSON.stringify(s))n.send("Not found.");else{let e="/home/matin/Documents/projects/facebook/userpost/";e+=o[0]._id,e+="/",e+=s[0]._id,showData(e).then(e=>{n.render("userpost.njk",{title:s[0].title,time:moment(s[0].time).fromNow(),username:t,data:e})}).catch(e=>{n.send("Error happened. Sorry")})}})})}),e.get("/forgot",(e,s)=>{s.render("forgot.njk")}),e.get("/forgotchange/:unique",(e,n)=>{const t=e.params.unique;s.User.find({forgot:t},(e,s)=>{if("[]"==JSON.stringify(s))n.redirect("/");else{const e=t.split("0"),s=e[e.length-1];n.render("changepass.njk",{username:s,unq:t})}})}),e.get("/token/:unq",(e,n)=>{const t=e.params.unq;s.User.find({emailurl:t},(e,s)=>{"[]"===JSON.stringify(s)?n.redirect("/"):(s[0].emailurl=null,s[0].save(e=>{if(e)throw e;n.send("Good")}))})})};module.exports=((e,s)=>{const n=(e,s,n)=>{if(e.session&&e.session.user)return n();e.flash("status","status0"),s.redirect("/")};e.get("/",(e,s)=>{if(e.session&&e.session.user)s.redirect("/you");else{const n=svgCaptcha.create({size:6,noise:2});e.session.captcha=n.text,s.render("index.njk",{captcha:n.data,flash:e.flash("status")})}}),e.get("/setting",n,(e,n)=>{s.checkUsername(e.session.user.toLowerCase()).then(e=>{n.render("setting.njk",{data:e[0]})}).catch(e=>{console.error(e),n.send("Error...")})}),e.get("/you",n,(e,n)=>{const t={username:e.session.user};s.User.find(t,(s,t)=>{n.render("admin.njk",{data:t[0],flash:e.flash("status")})})}),e.get("/q",(e,n)=>{const t=e.query.q,r=parseInt(e.query.tab);s.Post.find({title:{$regex:`.*${t}.*`,$options:"i"}}).skip(r).limit(20).sort({time:1}).then(e=>{const r=[],o=gen.getInfoSearch(e,s,r);!function e(){const s=o.next();s.done?n.render("searchall.njk",{list:r,q:t}):s.value.then(e)}()})}),e.get("/u/:username",(e,n)=>{if(e.query.tab){const t=e.params.username.toLowerCase();s.User.find({username:t},(s,r)=>{if("[]"!=JSON.stringify(r)){if("following"==e.query.tab){const s=parseInt(e.query.page);let o=10*s-10,a=10*s;const i=[];for(;o<a;o++)i.push(r[0].following[o]);const u=e=>void 0===e;let d=i.some(u);i.every(u)?n.render("listuser.njk",{status:1,done:!0,list:i,username:t,numPage:s}):n.render("listuser.njk",{status:1,done:!1,list:i,username:t,numPage:s,some:d})}else if("follower"==e.query.tab){const s=parseInt(e.query.page);let o=10*s-10,a=10*s;const i=[];for(;o<a;o++)i.push(r[0].follower[o]);const u=e=>void 0===e;let d=i.some(u);i.every(u)?n.render("listuser.njk",{status:2,done:!0,list:i,username:t,numPage:s}):n.render("listuser.njk",{status:2,done:!1,list:i,username:t,numPage:s,some:d})}}else n.render("usernotfound.njk",{url:t})})}else{const t=e.params.username.toLowerCase();s.User.find({username:t},(r,o)=>{if(r)throw r;if("[]"==JSON.stringify(o))n.render("usernotfound.njk",{url:t});else if(e.session&&e.session.user){const r=e.session.user.toLowerCase();let a,i,u=o[0].follower;s.checkUsername(r).then(e=>{a=e[0]._id}).then(()=>{i=u.some(e=>e===a);const r=[];s.Post.find({user:o[0]._id}).limit(10).sort({time:1}).exec().then(u=>{const d=gen.getInfo(u,a,r);!function a(){const u=d.next();u.done?s.Post.find({user:o[0]._id},(s,a)=>{i?n.render("userin.njk",{data:o[0],created:moment(o[0].created).fromNow(),self:e.session.user,isFollowed:!0,list:r,url:t,lenPost:a.length}):n.render("userin.njk",{data:o[0],created:moment(o[0].created).fromNow(),self:e.session.user,isFollowed:!1,list:r,url:t,lenPost:a.length})}):u.value.then(a)}()})}).catch(e=>{console.error(e)})}else n.render("userout.njk",{created:moment(o[0].created).fromNow(),data:o[0]})})}}),e.get("/contact",(e,s)=>{s.render("contact.njk")}),e.get("/u/:username/s/:address",(e,n)=>{const t=e.params.username.toLowerCase(),r=e.params.address;s.User.find({username:t},(e,o)=>{"[]"==JSON.stringify(o)?n.send("Username Does not exist."):s.Post.find({_id:r},(e,s)=>{if("[]"===JSON.stringify(s))n.send("Not found.");else{let e="/home/matin/Documents/projects/facebook/userpost/";e+=o[0]._id,e+="/",e+=s[0]._id,showData(e).then(e=>{n.render("userpost.njk",{title:s[0].title,time:moment(s[0].time).fromNow(),username:t,data:e})}).catch(e=>{n.send("Error happened. Sorry")})}})})}),e.get("/forgot",(e,s)=>{s.render("forgot.njk")}),e.get("/forgotchange/:unique",(e,n)=>{const t=e.params.unique;s.User.find({forgot:t},(e,s)=>{if("[]"==JSON.stringify(s))n.redirect("/");else{const e=t.split("0"),s=e[e.length-1];n.render("changepass.njk",{username:s,unq:t})}})}),e.get("/token/:unq",(e,n)=>{const t=e.params.unq;s.User.find({emailurl:t},(e,s)=>{"[]"===JSON.stringify(s)?n.redirect("/"):(s[0].emailurl=null,s[0].save(e=>{if(e)throw e;n.send("Good")}))})})});